Model:
  superclasses: [Subsystem, Instantiation, Observables, Introspection]
  
  items:
  - name: config
    type: Config
    default: Config()

  - name: warnings
    type: Warnings
    default: Warnings()

  - name: notifications
    type: Notifications
    default: Notifications()

  methods:
  - name: initialize
    doc: | 
      Initializes model, initialization blocks most of changes to 
      contained components (the attributes 

  - name: run_iterations
    doc: | 
       Runs specified number of iterations. Returns the number of iterations
       executed (it might be less than the requested number of iterations when 
       a checkpoint was scheduled). 
    return_type: uint64
    params:
    - name: iterations
      type: float
      doc: Number of iterations to run. Value is truncated to an integer.

  - name: end_simulation
    doc: |
      Generates the last visualization and reaction output (if they were defined), then
      flushes all buffers and optionally prints simulation report. 
      Buffers are also flushed when the Model object is destroyed.   
    params:
    - name: print_final_report
      type: bool
      default: True
      
  - name: add_subsystem
    params:
    - name: subsystem
      type: Subsystem*
      
  - name: add_instantiation
    params:
    - name: instantiation
      type: Instantiation*

  - name: add_observables
    params:
    - name: observables
      type: Observables*
      
  - name: dump_internal_state
    todo: all 'with' geometry option 
    doc: Prints out the simulation engine's internal state, mainly for debugging.      
      
  - name: export_data_model
    doc: | 
      If file is not set, then uses the first VizOutput to determine the target directory 
      and creates name using the current iteration. Fails if argument file is not set and there is no VizOutput.
      Must be called after initialization.
      Always exports the current state, i.e. with the current . 
      Events (ReleaseSites and VizOutputs) with scheduled time other than zero cannot be imported correectly yet.  
    params: 
    - name: file
      type: str
      default: unset
        
  - name: export_viz_data_model
    doc: Same as export_data_model, only the created data model will contain only information required for visualization
     in CellBlender. This makes the loading ofthemodel by CellBlender faster and also allows to avoid potential
     compatibility issues. 
    params: 
    - name: file
      type: str
      default: unset
     
  # --- state modification ---
  - name: release_molecules
    doc: | 
       Performs immediate release based on the definition of the release site argument.
       The ReleaseSite.release_time must not be in the past and should be withing the current iteration.
       The ReleaseEvent must not use a release_pattern because this is an immediate release and it is not 
       scheduled into the global scheduler. 
       
    params:
    - name: release_site
      type: ReleaseSite*
      
  - name: run_reaction
    doc: | 
      Run a single reaction on reactants. Callbacks will be called if they are registered for the given reaction.
      Returns a list of product IDs.
      Note\: only unimolecular reactions are currently supported.
    return_type: List[int]
    params:
    - name: reaction_rule
      type: ReactionRule*
      doc: Reaction rule to run.
      
    - name: reactant_ids
      type: List[int]
      doc: | 
        The number of reactants for a unimolecular reaction must be 1 and for a bimolecular reaction must be 2.
        Reactants for a bimolecular reaction do not have to be listed in the same order as in the reaction rule definition. 
    
    - name: time
      type: float
      doc: |
        Precise time in seconds when this reaction occurs. Important to know for how long the products
        will be diffused when they are created in a middle of a time step. 
      
  # --- dynamic geometry ---
      
  - name: add_vertex_move
    doc: Adds a displacement for given object's vertex, only stored until apply_vertex_moves is called
    params: 
    - name: object
      type: GeometryObject*
      doc: Object whose vertex will be changed
    - name: vertex_index
      type: int
      doc: Index of vertex in object's vertex list that will be changed
    - name: displacement
      type: Vec3
      doc: Change of vertex coordinates (in um), will be added to the current coordinates of the vertex 
      
  - name: apply_vertex_moves
    doc: | 
       Applies all the vertex moves specified with add_vertex_move call.
       Walls of different objects are checked against collisions and move the maximal way so that they do not 
       overlap. (the current pllementation is a bit basic and may not work 100% correctly) 
       When collect_wall_wall_hits is True, a list of wall pairs that collided is returned,
       when collect_wall_wall_hits is False, and empty list is returned.
    return_type: List[WallWallHitInfo*]
    params:
    - name: collect_wall_wall_hits
      type: bool
      default: false
      doc: |
         When set to True, a list of wall pairs that collided is returned,
         otherwise an empty list is returned.
  
  # --- callbacks ---
  
  - name: register_mol_wall_hit_callback
    doc: There can be currently only a single wall hit callback registered.
    params:
    - name: function
      type: std::function<void(std::shared_ptr<MolWallHitInfo>, py::object)>
      doc: | 
         Callback function to be called. 
         It must have two arguments MolWallHitInfo and context.
      internal: Use a more abstract format to define function type 

    - name: context
      type: py::object
      doc: | 
         Context passed to the callback function, the callback function can store
         information to this object. Some context must be always passed, even when 
         it is a useless python object. 
     
    - name: object
      type: GeometryObject*
      default: unset
      doc: Only hits of this object will be reported, any object hit is reported when not set.
      internal: Extend this to Region later
      
    - name: species
      type: Species*
      default: unset
      doc: Only hits of molecules of this species will be reported, any species hit is reported when not set.
      
      
  - name: register_reaction_callback
    doc: | 
       Defines a function to be called when a reaction was processed.
       It is allowed to do state modifications except for removing reacting molecules, 
       they will be removed automatically after return from this callback.  
    params: 
    - name: function
      type: std::function<void(std::shared_ptr<ReactionInfo>, py::object)>
      doc: | 
         Callback function to be called. 
         It must have two arguments ReactionInfo and context.
         Called when it is decided that the reaction will happen.
         After return the reaction proceeds as it would without a callback. 
         
    - name: context
      type: py::object
      doc: | 
         Context passed to the callback function, the callback function can store
         information to this object. Some context must be always passed, even when 
         it is a useless python object. 
      internal: |
         In the future, One may set attributes of ReactionInfo to say how the reaction should proceed. 
         If unchanged, reaction proceeds as it woudl without this callback. 
         
    - name: reaction_rule
      type: ReactionRule*
      internal: maybe also add filtering by species
      doc: The callback function will be called whenever is this reaction rule applied.
          
  # --- other ---
  
  - name: load_bngl
    doc: | 
      Loads sections\: molecule types, reaction rules, seed species, and observables from a BNGL file
      and creates objects in the current model according to it.
      All elementary molecule types used in the seed species section must be defined in subsystem.
      If an item in the seed species section does not have its compartment set,
      the argument default_region must be set and the molecules are released into or onto the 
      default_region. 
    params:
    - name: file_name
      type: str  
      
    - name: observables_files_prefix
      type: str
      default: ""
      doc: Prefix to be used when creating files with observable values. 
      
    - name: default_release_region
      type: Region*
      default: unset
      
    - name: parameter_overrides
      type: Dict[str, float]
      default: empty
      
  - name: export_to_bngl
    doc: |
      Exports all defined species, reaction rules and applicable observables
      as a BNGL file. 
      Limited currrently to exactly one volume compartment and volume reactions.
    params:
    - name: file_name
      type: str
      doc: Output file name.
      
  - name: save_checkpoint
    doc: |
       Saves current model state as checkpoint. 
       The default directory structure is checkpoints/seed_<SEED>/it_<ITERATION>,
       it can be changed by setting 'custom_dir'.
       If used during an iteration, schedules an event for the end of the current iteration
       that saves the checkpoint (effectively calls 'checkpoint_after_iteration(0, False, custom_dir)'.  
    params:
    - name: custom_dir
      type: str
      default: unset
      doc: |
         Sets custom directory where the checkpoint will be stored. 
         The default is 'checkpoints/seed_<SEED>/it_<ITERATION>'. 

  - name: schedule_checkpoint
    doc: |
       Schedules checkpoint save that will occur when an iteration is started  
       right before any other events scheduled for the given iteration are executed.
       Can be called asynchronously at any time after initialization.
       
    params:
    - name: iteration
      type: uint64
      default: 0
      doc: |
        Specifies iteration number when the checkpoint save will occur. 
        Please note that iterations are counted from 0, i.e. a call run_iterations(3)
        runs iterations 0, 1, 2.
        To schedule a checkpoint for the closest time as possible, keep the default value 0. 
    
    - name: return_from_run_iterations
      type: bool
      default: true
      doc: |
        When true, saving the checkpoint means that we want to terminate the simulation 
        right after the save, the currently running function Model.run_iterations
        does not simulate any following iterations and execution returns from this function
        (e.g. to execute the next statement which is usually 'model.end_simulation()'.
        When false, the checkpoint is just saved and simulation continues uninterrupted.
              
    - name: custom_dir
      type: str
      default: unset
      doc: |
         Sets custom directory where the checkpoint will be stored. 
         The default is 'checkpoints/seed_<SEED>/it_<ITERATION>'. 
               